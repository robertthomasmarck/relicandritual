---
import BaseLayout from "@layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";

// Get itinerary content from markdown
const itineraryEntries = await getCollection("itinerary", ({ data }) => {
	return data.draft !== true;
});
const entry = itineraryEntries[0];
const { Content } = await render(entry);

// Auth token for API calls (optional)
const authToken = import.meta.env.PUBLIC_CHECKLIST_AUTH_TOKEN || "";
---

<BaseLayout title="Year of Bones" description="Itinerary for Year of Bones" navStartStyle="white">
	<!-- Hero Banner -->
	<section class="relative flex h-[50vh] min-h-[400px] w-full items-center justify-center overflow-hidden">
		<div class="absolute inset-0 z-0">
			<video id="hero-video" autoplay muted loop playsinline class="h-full w-full object-cover">
				<source src="/video/flying-monastery.mp4" type="video/mp4" />
			</video>
			<div class="absolute inset-0" style="background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.1) 45%, rgba(0,0,0,1) 100%);"></div>
			<div class="absolute inset-0" style="background: radial-gradient(circle at 50% 43%, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 5%, rgba(255,255,255,0) 15%);"></div>
		</div>
		<div class="relative z-10 text-center">
			<h1 class="font-heading-1 text-5xl md:text-7xl text-white uppercase tracking-widest">Year of Bones</h1>
			<p class="text-white" style="font-family: 'TCHamilton', cursive; font-size: 4rem; margin-top: 2.25rem;">Itinerary</p>
		</div>
		<!-- Video pause/play button -->
		<button
			id="video-toggle"
			class="absolute bottom-4 right-4 z-20 flex h-10 w-10 items-center justify-center rounded-full bg-black/50 text-white transition hover:bg-black/70"
			aria-label="Pause video"
		>
			<svg id="pause-icon" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
				<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
			</svg>
			<svg id="play-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
				<path d="M8 5v14l11-7z"/>
			</svg>
		</button>
	</section>

<script>
	const video = document.getElementById('hero-video') as HTMLVideoElement;
	const toggleBtn = document.getElementById('video-toggle');
	const pauseIcon = document.getElementById('pause-icon');
	const playIcon = document.getElementById('play-icon');

	toggleBtn?.addEventListener('click', () => {
		if (video.paused) {
			video.play();
			pauseIcon?.classList.remove('hidden');
			playIcon?.classList.add('hidden');
			toggleBtn.setAttribute('aria-label', 'Pause video');
		} else {
			video.pause();
			pauseIcon?.classList.add('hidden');
			playIcon?.classList.remove('hidden');
			toggleBtn.setAttribute('aria-label', 'Play video');
		}
	});
</script>

	<section class="mx-auto w-[90%] md:w-[70%] py-16 md:py-24">
		<div class="text-base-content markdown-content text-sm md:text-base" id="checklist-content">
			<Content />
		</div>
	</section>
</BaseLayout>

<style>
	/* Style the checkboxes */
	#checklist-content :global(input[type="checkbox"]) {
		width: 1.1rem;
		height: 1.1rem;
		accent-color: #d97706;
		cursor: pointer;
		margin-right: 0.5rem;
	}

	#checklist-content :global(input[type="checkbox"]:disabled) {
		cursor: wait;
		opacity: 0.5;
	}

	/* Strike through checked items */
	#checklist-content :global(li:has(input[type="checkbox"]:checked)) {
		color: #9ca3af;
		text-decoration: line-through;
	}

	/* Loading state */
	#checklist-content.loading :global(input[type="checkbox"]) {
		pointer-events: none;
		opacity: 0.5;
	}
</style>

<script define:vars={{ authToken }}>
	// Interactive checkbox functionality
	const CHECKLIST_ID = "year-of-bones";
	const AUTH_TOKEN = authToken;

	// Generate stable ID from checkbox label text
	function generateId(text) {
		// Simple hash: use first 16 chars of base64 encoded text
		return btoa(text.trim().toLowerCase().slice(0, 30))
			.replace(/[^a-zA-Z0-9]/g, "")
			.slice(0, 16);
	}

	// Fetch saved state from Sanity
	async function loadChecklistState() {
		try {
			const response = await fetch(`/api/checklist?id=${encodeURIComponent(CHECKLIST_ID)}`);
			if (!response.ok) return {};
			const data = await response.json();
			const state = {};
			data.items?.forEach((item) => {
				state[item.id] = item.checked;
			});
			return state;
		} catch (error) {
			console.error("Failed to load checklist state:", error);
			return {};
		}
	}

	// Save checkbox state to Sanity
	async function saveCheckboxState(checkboxId, checked, label) {
		try {
			const headers = {
				"Content-Type": "application/json",
			};
			if (AUTH_TOKEN) {
				headers["Authorization"] = `Bearer ${AUTH_TOKEN}`;
			}

			const response = await fetch("/api/checklist", {
				method: "POST",
				headers,
				body: JSON.stringify({
					identifier: CHECKLIST_ID,
					checkboxId,
					checked,
					label,
				}),
			});

			return response.ok;
		} catch (error) {
			console.error("Failed to save checkbox state:", error);
			return false;
		}
	}

	// Initialize checkboxes
	async function initCheckboxes() {
		const container = document.getElementById("checklist-content");
		if (!container) return;

		// Add loading class
		container.classList.add("loading");

		// Find all checkboxes
		const checkboxes = container.querySelectorAll('input[type="checkbox"]');

		// Load saved state
		const savedState = await loadChecklistState();

		// Enable and configure each checkbox
		checkboxes.forEach((checkbox) => {
			// Get the label text from the parent li
			const li = checkbox.closest("li");
			const labelText = li?.textContent?.trim() || "";
			const checkboxId = generateId(labelText);

			// Remove disabled attribute (markdown renders them disabled by default)
			checkbox.removeAttribute("disabled");

			// Apply saved state if exists
			if (savedState[checkboxId] !== undefined) {
				checkbox.checked = savedState[checkboxId];
			}

			// Add change listener
			checkbox.addEventListener("change", async (e) => {
				const target = e.target;
				const newChecked = target.checked;

				// Disable while saving
				target.disabled = true;

				const success = await saveCheckboxState(checkboxId, newChecked, labelText);

				if (!success) {
					// Revert on failure
					target.checked = !newChecked;
				}

				// Re-enable
				target.disabled = false;
			});
		});

		// Remove loading class
		container.classList.remove("loading");
	}

	// Run on page load
	document.addEventListener("DOMContentLoaded", initCheckboxes);

	// Also run immediately in case DOM is already loaded
	if (document.readyState !== "loading") {
		initCheckboxes();
	}
</script>
